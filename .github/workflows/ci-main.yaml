name: "Push Export"
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  GODOT_VERSION: 4.5
  EXPORT_NAME: cat
  ITCH_IO: true #set to true if you want to enable automatic itch.io deploy

jobs:
  check-concurrent:
    name: Check for Concurrent Runs
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - name: Skip if workflow already running
        id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          concurrent_skipping: "always"
          skip_after_successful_duplicate: "false"
          do_not_skip: "[]"

  extract-version:
    name: Extract Version from Cargo.toml
    runs-on: ubuntu-latest
    needs: check-concurrent
    if: needs.check-concurrent.outputs.should_skip != 'true'
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from Cargo.toml
        id: get-version
        run: |
          VERSION=$(grep -m1 '^version = ' axum/Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

  check-version:
    name: Check if Version Exists
    runs-on: ubuntu-latest
    needs: extract-version
    permissions:
      contents: read
      packages: write
      issues: write
    outputs:
      should_build: ${{ steps.check-version.outputs.should_build }}
      issue_number: ${{ steps.create-issue.outputs.result }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.UNITY_PAT }}

      - name: Check if version exists in GHCR
        id: check-version
        continue-on-error: true
        run: |
          VERSION=${{ needs.extract-version.outputs.version }}
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')

          echo "Checking for image: ghcr.io/${REPO_LOWER}:${VERSION}"

          # Check if the version tag exists in GHCR
          if docker manifest inspect ghcr.io/${REPO_LOWER}:${VERSION} > /dev/null 2>&1; then
              echo "‚úì Image version ${VERSION} already exists in GHCR"
              echo "should_build=false" >> $GITHUB_OUTPUT
          else
              echo "‚úó Image version ${VERSION} does not exist, will build and push"
              echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Create tracking issue in KBVE repo
        id: create-issue
        if: steps.check-version.outputs.should_build == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.UNITY_PAT }}
          script: |
            const version = '${{ needs.extract-version.outputs.version }}';
            const issue = await github.rest.issues.create({
              owner: 'KBVE',
              repo: 'kbve',
              title: `[CityVote] Deployment Pipeline for v${version}`,
              body: `## CityVote Deployment Pipeline - v${version}

            This issue tracks the automated deployment pipeline for CityVote version ${version}.

            ### Pipeline Status

            - [x] Version extracted from Cargo.toml: \`${version}\`
            - [ ] Godot WebGL build
            - [ ] Docker image build
            - [ ] Push to GHCR
            - [ ] Deploy to Itch.io
            - [ ] Deploy to GitHub Pages
            - [ ] Update deployment manifest
            - [ ] Create pull request

            ### Source Information
            - **Repository:** ${{ github.repository }}
            - **Commit:** ${{ github.sha }}
            - **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - **Triggered by:** @${{ github.actor }}

            ---
            ü§ñ This issue was automatically created by the CityVote CI pipeline.`,
              labels: ['automated', 'deployment', 'cityvote']
            });
            console.log(`Created issue #${issue.data.number}`);
            return issue.data.number;

  export-web:
    name: Web Export
    runs-on: ubuntu-24.04
    needs: [check-concurrent, check-version]
    if: needs.check-concurrent.outputs.should_skip != 'true' && needs.check-version.outputs.should_build == 'true'
    container:
      image: barichello/godot-ci:4.5
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mkdir -v -p ~/.config/
          mv /root/.config/godot ~/.config/godot
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
      - name: Web Build
        run: |
          mkdir -v -p builds/web
          cd cat
          godot -v --headless --export-release "Web" ../builds/web/index.html

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web
          path: builds/web
          retention-days: 1
      - name: Zip Folder
        run: zip -r itch.zip builds/web
      - name: Deploy to itch.io
        if: ${{ env.ITCH_IO=='true' }}
        uses: josephbmanley/butler-publish-itchio-action@master
        env:
          BUTLER_CREDENTIALS: ${{ secrets.ITCH_API }}
          CHANNEL: HTML
          ITCH_GAME: cityvote
          ITCH_USER: kbve
          PACKAGE: itch.zip

      - name: Update issue - Godot build complete
        if: success() && needs.check-version.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.UNITY_PAT }}
          script: |
            const issueNumber = ${{ needs.check-version.outputs.issue_number }};

            // Get the current issue body
            const { data: issue } = await github.rest.issues.get({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber
            });

            // Update the checklist items
            let body = issue.body;
            body = body.replace('- [ ] Godot WebGL build', '- [x] Godot WebGL build');
            body = body.replace('- [ ] Deploy to Itch.io', '- [x] Deploy to Itch.io');

            await github.rest.issues.update({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber,
              body: body
            });

      - name: Update issue - Godot build failed
        if: failure() && needs.check-version.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.UNITY_PAT }}
          script: |
            const issueNumber = ${{ needs.check-version.outputs.issue_number }};
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            await github.rest.issues.createComment({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber,
              body: `### ‚ùå Godot Build Failed

            The Godot WebGL build failed.

            **Action Required:** Please check the [workflow logs](${runUrl}) for details.

            The pipeline has been halted.`
            });

            await github.rest.issues.addLabels({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber,
              labels: ['failed']
            });

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [extract-version, check-version, export-web]
    if: needs.check-version.outputs.should_build == 'true'
    permissions:
      contents: read
      packages: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download web build artifact
        uses: actions/download-artifact@v4
        with:
          name: web
          path: builds/web

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.UNITY_PAT }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=${{ needs.extract-version.outputs.version }}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            EXPECTED_VERSION=${{ needs.extract-version.outputs.version }}

      - name: Verify push to GHCR
        run: |
          VERSION=${{ needs.extract-version.outputs.version }}
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')

          echo "Verifying pushed image..."
          if docker manifest inspect ghcr.io/${REPO_LOWER}:${VERSION} > /dev/null 2>&1; then
              echo "‚úì Successfully verified image in GHCR: ghcr.io/${REPO_LOWER}:${VERSION}"
          else
              echo "‚úó Failed to verify image in GHCR"
              exit 1
          fi

      - name: Update issue - Docker build complete
        if: success() && needs.check-version.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.UNITY_PAT }}
          script: |
            const version = '${{ needs.extract-version.outputs.version }}';
            const issueNumber = ${{ needs.check-version.outputs.issue_number }};
            const repoLower = '${{ github.repository }}'.toLowerCase();

            // Get the current issue body
            const { data: issue } = await github.rest.issues.get({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber
            });

            // Update the checklist items
            let body = issue.body;
            body = body.replace('- [ ] Docker image build', '- [x] Docker image build');
            body = body.replace('- [ ] Push to GHCR', '- [x] Push to GHCR');

            await github.rest.issues.update({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber,
              body: body
            });

            // Add a comment with details
            await github.rest.issues.createComment({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber,
              body: `### ‚úÖ Docker Build Successful

            Docker image has been successfully built and pushed to GHCR.

            - **Image:** \`ghcr.io/${repoLower}:${version}\`
            - **Tags:** \`${version}\`, \`latest\`
            - **Platform:** \`linux/amd64\`
            - **Includes:** Godot WebGL game

            Next step: Deployment manifest and PR...`
            });

      - name: Update issue - Docker build failed
        if: failure() && needs.check-version.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.UNITY_PAT }}
          script: |
            const issueNumber = ${{ needs.check-version.outputs.issue_number }};
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            await github.rest.issues.createComment({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber,
              body: `### ‚ùå Docker Build Failed

            The Docker build or push to GHCR failed.

            **Action Required:** Please check the [workflow logs](${runUrl}) for details.

            The pipeline has been halted.`
            });

            await github.rest.issues.addLabels({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber,
              labels: ['failed']
            });

  update-kbve-manifest:
    name: Update Deployment Manifest in KBVE Repo
    runs-on: ubuntu-latest
    needs: [extract-version, check-version, build-and-push]
    if: needs.check-version.outputs.should_build == 'true'
    permissions:
      contents: write
      pull-requests: write
      issues: write
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pull-request-number }}
    steps:
      - name: Checkout KBVE repository
        uses: actions/checkout@v4
        with:
          repository: KBVE/kbve
          ref: main
          token: ${{ secrets.UNITY_PAT }}

      - name: Update deployment manifest
        run: |
          VERSION=${{ needs.extract-version.outputs.version }}
          MANIFEST_FILE="apps/kube/cityvote/manifest/cityvote-deployment.yaml"

          echo "Updating image tag to: ghcr.io/kbve/cityvote:${VERSION}"

          # Update the image tag in the deployment manifest
          sed -i "s|image: ghcr.io/kbve/cityvote:.*|image: ghcr.io/kbve/cityvote:${VERSION}|g" "$MANIFEST_FILE"

          echo "Updated manifest:"
          grep "image: ghcr.io/kbve/cityvote" "$MANIFEST_FILE"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.UNITY_PAT }}
          commit-message: "chore: update cityvote deployment to version ${{ needs.extract-version.outputs.version }}"
          branch: cityvote-deploy-${{ needs.extract-version.outputs.version }}
          delete-branch: true
          title: "Update CityVote deployment to v${{ needs.extract-version.outputs.version }}"
          body: |
            ## Automated Deployment Update

            This PR updates the CityVote Kubernetes deployment manifest to use the newly built image.

            **Changes:**
            - Updated `apps/kube/cityvote/manifest/cityvote-deployment.yaml`
            - New image tag: `ghcr.io/kbve/cityvote:${{ needs.extract-version.outputs.version }}`

            **Tracking Issue:** #${{ needs.check-version.outputs.issue_number }}

            **Source:**
            - Triggered by: ${{ github.repository }}@${{ github.sha }}
            - Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ü§ñ This PR was automatically generated by the CityVote CI pipeline.

            Closes #${{ needs.check-version.outputs.issue_number }}
          base: main
          labels: |
            automated
            deployment
            cityvote

      - name: Update issue checklist - Manifest updated
        if: steps.create-pr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.UNITY_PAT }}
          script: |
            const issueNumber = ${{ needs.check-version.outputs.issue_number }};

            // Get the current issue body
            const { data: issue } = await github.rest.issues.get({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber
            });

            // Update the checklist items
            let body = issue.body;
            body = body.replace('- [ ] Update deployment manifest', '- [x] Update deployment manifest');
            body = body.replace('- [ ] Create pull request', '- [x] Create pull request');

            await github.rest.issues.update({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber,
              body: body
            });

      - name: Link PR to issue
        if: steps.create-pr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.UNITY_PAT }}
          script: |
            const version = '${{ needs.extract-version.outputs.version }}';
            const issueNumber = ${{ needs.check-version.outputs.issue_number }};
            const prNumber = ${{ steps.create-pr.outputs.pull-request-number }};
            const prUrl = `https://github.com/KBVE/kbve/pull/${prNumber}`;

            await github.rest.issues.createComment({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber,
              body: `### ‚úÖ Deployment Manifest Updated

            Pull request has been created to update the deployment manifest.

            **Pull Request:** #${prNumber}
            **Branch:** \`cityvote-deploy-${version}\`
            **Changes:** Updated \`apps/kube/cityvote/manifest/cityvote-deployment.yaml\` to use \`ghcr.io/kbve/cityvote:${version}\`

            Please review and merge the PR to complete the deployment.`
            });

      - name: Update issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.UNITY_PAT }}
          script: |
            const issueNumber = ${{ needs.check-version.outputs.issue_number }};
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            await github.rest.issues.createComment({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber,
              body: `### ‚ùå Manifest Update Failed

            Failed to update the deployment manifest or create the pull request.

            **Action Required:** Please check the [workflow logs](${runUrl}) for details.`
            });
            await github.rest.issues.addLabels({
              owner: 'KBVE',
              repo: 'kbve',
              issue_number: issueNumber,
              labels: ['failed']
            });
